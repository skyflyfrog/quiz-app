<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤©ç¿”æµè‡ªæˆ‘å¼·åŒ–æª¢æ ¸è¡¨</title>
<style>
body {
  font-family: "Noto Sans TC", sans-serif;
  background: #f4f5f7;
  text-align: center;
  margin: 0;
  padding: 40px 0;
}
h1 {
  font-size: 2em;
  margin-bottom: 20px;
}
p.description {
  color: #555;
  margin-bottom: 25px;
  font-size: 1.05em;
}
.container {
  background: white;
  border-radius: 16px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  margin: 0 auto;
  padding: 20px;
  width: 85%;
  max-width: 720px;
}
button {
  font-size: 1.1em;
  padding: 10px 24px;
  margin: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
#checkBtn { background: #008CBA; color: white; }
#wrongBtn { background: #f44336; color: white; }
#rightBtn { background: #4CAF50; color: white; }
#nextBtn { background: #333; color: white; }
.hidden { display: none; }
.progressBar {
  width: 100%;
  height: 20px;
  background: #ddd;
  border-radius: 10px;
  margin: 20px 0;
  overflow: hidden;
  display: flex;
}
.progressSegment { height: 100%; }
.red { background: #f44336; }
.yellow { background: #ffca28; }
.green { background: #4caf50; }
.blue { background: #2196f3; }
#question, #answer {
  color: black;
  font-size: 1.3em;
  margin: 15px 0;
}
</style>
</head>
<body>
<h1>å¤©ç¿”æµè‡ªæˆ‘å¼·åŒ–æª¢æ ¸è¡¨</h1>
<p class="description">é¸æ“‡ä½ è¦åˆ·çš„å–®å…ƒ â†’ è¼‰å…¥é¡Œåº« â†’ é¸æ“‡å°ç¯€ â†’ é–‹å§‹åˆ·</p>

<div class="container" id="setupBox">
  <label>é¸æ“‡å–®å…ƒï¼š</label>
  <select id="unitSelect"></select>
  <label>ã€€é¸æ“‡å°ç¯€ï¼š</label>
  <select id="sectionSelect"></select><br>
  <button id="loadBtn">è¼‰å…¥é¡Œåº«</button>
</div>

<div class="container hidden" id="quizBox">
  <h3 id="progress"></h3>
  <h2 id="question"></h2>
  <p id="answer" class="hidden"></p>
  <div>
    <button id="checkBtn">å°ç­”æ¡ˆ</button>
    <button id="wrongBtn" class="hidden">ç­”éŒ¯</button>
    <button id="rightBtn" class="hidden">ç­”å°</button>
    <button id="nextBtn" class="hidden">ä¸‹ä¸€é¡Œ</button>
  </div>
</div>

<div class="container hidden" id="statBox">
  <h2>ğŸ“Š çµ±è¨ˆçµæœ</h2>
  <div id="progressContainer" class="progressBar"></div>
  <p id="statResult"></p>
  <button onclick="filterColor('red')" class="red">åªåˆ·ç´…è‰²</button>
  <button onclick="filterColor('yellow')" class="yellow">åªåˆ·é»ƒè‰²</button>
  <button onclick="filterColor('green')" class="green">åªåˆ·ç¶ è‰²</button>
  <button onclick="filterColor('blue')" class="blue">åªåˆ·è—è‰²</button><br>
  <button onclick="restartAll()">å…¨éƒ¨é‡åˆ·</button>
  <button onclick="backToSetup()">å›ä¸»ç•«é¢</button>
</div>

<script>
let allData = {};
let deck = [];
let idx = 0;
let currentSheet = "";
let currentSection = "";
const sheetUrl = "https://script.google.com/macros/s/AKfycbyzdhcYNXrPhqtPh2jaIhoO3FNZ1r1FdxB7obTXKWosJ4HRWCRoMEWgLZUgqUs3lYtGEg/exec";

const setupBox = document.getElementById("setupBox");
const quizBox = document.getElementById("quizBox");
const statBox = document.getElementById("statBox");
const questionText = document.getElementById("question");
const answerText = document.getElementById("answer");
const progressText = document.getElementById("progress");
const checkBtn = document.getElementById("checkBtn");
const wrongBtn = document.getElementById("wrongBtn");
const rightBtn = document.getElementById("rightBtn");
const nextBtn = document.getElementById("nextBtn");
const sectionSelect = document.getElementById("sectionSelect");
const unitSelect = document.getElementById("unitSelect");

// ğŸš€ è‡ªå‹•æŠ“åˆ†é åç¨±
async function loadSheetList(){
  try{
    const res = await fetch(sheetUrl + "?mode=sheets");
    const data = await res.json();
    const sheets = data.sheets || [];
    if(sheets.length === 0) throw new Error("No sheets found");
    unitSelect.innerHTML = sheets.map(s => `<option value="${s}">${s}</option>`).join("");
  }catch(e){
    alert("âš ï¸ ç„¡æ³•å–å¾—è©¦ç®—è¡¨åˆ†é æ¸…å–®ï¼Œè«‹ç¢ºèª Apps Script æœ‰å›å‚³ sheets é™£åˆ—ã€‚");
  }
}

document.addEventListener("DOMContentLoaded", loadSheetList);

document.getElementById("loadBtn").onclick = async ()=>{
  try {
    currentSheet = unitSelect.value;
    const res = await fetch(sheetUrl + "?sheet=" + encodeURIComponent(currentSheet));
    allData[currentSheet] = await res.json();
    const sections = [...new Set(allData[currentSheet].map(q => q.å°ç¯€))];
    sectionSelect.innerHTML = "<option value=''>è«‹é¸æ“‡</option>" + sections.map(s => `<option>${s}</option>`).join("");
  } catch (e) {
    alert("âš ï¸ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¢ºèª Apps Script ç¶²å€æ˜¯å¦æ­£ç¢ºç™¼å¸ƒã€‚");
  }
};

sectionSelect.onchange = ()=>{
  currentSection = sectionSelect.value;
  if(currentSection){
    deck = allData[currentSheet].filter(q => q.å°ç¯€ === currentSection);
    deck.forEach(q => q.color = q.color || "red");
    setupBox.classList.add("hidden");
    quizBox.classList.remove("hidden");
    idx = 0;
    showQuestion();
  }
};

function showQuestion(){
  const q = deck[idx];
  questionText.textContent = `${idx+1}. ${q.é¡Œç›®}`;
  answerText.textContent = "ç­”æ¡ˆï¼š" + q.ç­”æ¡ˆ;
  answerText.classList.add("hidden");
  progressText.textContent = `ç¬¬ ${idx+1}/${deck.length} é¡Œã€€å°ç¯€ï¼š${q.å°ç¯€}`;
  checkBtn.classList.remove("hidden");
  wrongBtn.classList.add("hidden");
  rightBtn.classList.add("hidden");
  nextBtn.classList.add("hidden");
}

checkBtn.onclick = ()=>{
  answerText.classList.remove("hidden");
  checkBtn.classList.add("hidden");
  wrongBtn.classList.remove("hidden");
  rightBtn.classList.remove("hidden");
};

wrongBtn.onclick = ()=>{
  updateColor(deck[idx], "red");
  goNext();
};

rightBtn.onclick = ()=>{
  const q = deck[idx];
  if(q.color === "red") updateColor(q, "yellow");
  else if(q.color === "yellow") updateColor(q, "green");
  else if(q.color === "green") updateColor(q, "blue");
  goNext();
};

nextBtn.onclick = ()=> goNext();

function updateColor(q, newColor){
  q.color = newColor;
  const target = allData[currentSheet].find(d => d.é¡Œç›® === q.é¡Œç›® && d.å°ç¯€ === q.å°ç¯€);
  if(target) target.color = newColor;
}

function goNext(){
  idx++;
  if(idx >= deck.length) showStats();
  else showQuestion();
}

function showStats(){
  quizBox.classList.add("hidden");
  statBox.classList.remove("hidden");

  const sectionData = allData[currentSheet].filter(q => q.å°ç¯€ === currentSection);
  const counts = { red:0, yellow:0, green:0, blue:0 };
  sectionData.forEach(q => {
    const c = q.color || "red";
    counts[c] = (counts[c] || 0) + 1;
  });
  const total = sectionData.length;

  document.getElementById("statResult").innerHTML =
    `ç´…ï¼š${counts.red}ã€€é»ƒï¼š${counts.yellow}ã€€ç¶ ï¼š${counts.green}ã€€è—ï¼š${counts.blue}ã€€<small>ï¼ˆç¸½è¨ˆ ${total} é¡Œï¼‰</small>`;

  const bar = document.getElementById("progressContainer");
  bar.innerHTML = "";
  ["red","yellow","green","blue"].forEach(c=>{
    const seg = document.createElement("div");
    seg.classList.add("progressSegment", c);
    seg.style.width = (counts[c]/total*100)+"%";
    bar.appendChild(seg);
  });
}

function filterColor(color){
  deck = allData[currentSheet].filter(q => q.å°ç¯€ === currentSection && q.color === color);
  if(deck.length === 0){ alert("æ²’æœ‰é€™é¡è‰²çš„é¡Œç›®å–”"); return; }
  idx = 0;
  statBox.classList.add("hidden");
  quizBox.classList.remove("hidden");
  showQuestion();
}

function restartAll(){
  deck = allData[currentSheet].filter(q => q.å°ç¯€ === currentSection);
  idx = 0;
  statBox.classList.add("hidden");
  quizBox.classList.remove("hidden");
  showQuestion();
}

function backToSetup(){
  statBox.classList.add("hidden");
  setupBox.classList.remove("hidden");
}
</script>
</body>
</html>
