<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤©ç¿”æµè‡ªæˆ‘å¼·åŒ–æª¢æ ¸è¡¨</title>
<style>
body {
  font-family: "Noto Sans TC", sans-serif;
  background: #f4f5f7;
  text-align: center;
  margin: 0;
  padding: 40px 0;
}
h1 {
  font-size: 2em;
  margin-bottom: 30px;
}
.container {
  background: white;
  border-radius: 16px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  margin: 0 auto;
  padding: 20px;
  width: 85%;
  max-width: 720px;
}
button {
  font-size: 1.1em;
  padding: 10px 24px;
  margin: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
#checkBtn { background: #008CBA; color: white; }
#wrongBtn { background: #f44336; color: white; }
#rightBtn { background: #4CAF50; color: white; }
#nextBtn { background: #333; color: white; }
.hidden { display: none; }
.progressBar {
  width: 100%;
  height: 20px;
  background: #ddd;
  border-radius: 10px;
  margin: 20px 0;
  overflow: hidden;
  display: flex;
}
.progressSegment { height: 100%; }
.red { background: #f44336; }
.yellow { background: #ffca28; }
.green { background: #4caf50; }
.blue { background: #2196f3; }
</style>
</head>
<body>
<h1>å¤©ç¿”æµè‡ªæˆ‘å¼·åŒ–æª¢æ ¸è¡¨</h1>

<div class="container" id="setupBox">
  <label>é¸æ“‡å–®å…ƒï¼š</label>
  <select id="unitSelect">
    <option>è‡ªç„¶B1L2é¤Šåˆ†</option>
  </select>
  <label>ã€€é¸æ“‡å°ç¯€ï¼š</label>
  <select id="sectionSelect"></select><br>
  <button id="loadBtn">è¼‰å…¥é¡Œåº«</button>
</div>

<div class="container hidden" id="quizBox">
  <h3 id="progress"></h3>
  <h2 id="question"></h2>
  <p id="answer" class="hidden"></p>
  <div>
    <button id="checkBtn">å°ç­”æ¡ˆ</button>
    <button id="wrongBtn" class="hidden">ç­”éŒ¯</button>
    <button id="rightBtn" class="hidden">ç­”å°</button>
    <button id="nextBtn" class="hidden">ä¸‹ä¸€é¡Œ</button>
  </div>
</div>

<div class="container hidden" id="statBox">
  <h2>ğŸ“Š çµ±è¨ˆçµæœ</h2>
  <div id="progressContainer" class="progressBar"></div>
  <p id="statResult"></p>
  <button onclick="filterColor('red')" class="red">åªåˆ·ç´…è‰²</button>
  <button onclick="filterColor('yellow')" class="yellow">åªåˆ·é»ƒè‰²</button>
  <button onclick="filterColor('green')" class="green">åªåˆ·ç¶ è‰²</button>
  <button onclick="filterColor('blue')" class="blue">åªåˆ·è—è‰²</button><br>
  <button onclick="restartAll()">å…¨éƒ¨é‡åˆ·</button>
  <button onclick="backToSetup()">å›ä¸»ç•«é¢</button>
</div>

<script>
let allData = [];
let deck = [];
let idx = 0;
let setupBox = document.getElementById("setupBox");
let quizBox = document.getElementById("quizBox");
let statBox = document.getElementById("statBox");
let questionText = document.getElementById("question");
let answerText = document.getElementById("answer");
let progressText = document.getElementById("progress");
let checkBtn = document.getElementById("checkBtn");
let wrongBtn = document.getElementById("wrongBtn");
let rightBtn = document.getElementById("rightBtn");
let nextBtn = document.getElementById("nextBtn");
let sectionSelect = document.getElementById("sectionSelect");

document.getElementById("loadBtn").onclick = async ()=>{
  try {
    const sheetUrl = "https://script.google.com/macros/s/AKfycbyzdhcYNXrPhqtPh2jaIhoO3FNZ1r1FdxB7obTXKWosJ4HRWCRoMEWgLZUgqUs3lYtGEg/exec";
    const res = await fetch(sheetUrl + "?sheet=è‡ªç„¶B1L2é¤Šåˆ†");
    allData = await res.json();
    const sections = [...new Set(allData.map(q => q.å°ç¯€))];
    sectionSelect.innerHTML = "<option value=''>è«‹é¸æ“‡</option>" + sections.map(s => `<option>${s}</option>`).join("");
  } catch (e) {
    alert("âš ï¸ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¢ºèª Apps Script ç¶²å€æ˜¯å¦æ­£ç¢ºç™¼å¸ƒã€‚");
  }
};

sectionSelect.onchange = ()=>{
  const selected = sectionSelect.value;
  if(selected){
    deck = allData.filter(q => q.å°ç¯€ === selected);
    deck.forEach(q => q.color = q.color || "red");
    setupBox.classList.add("hidden");
    quizBox.classList.remove("hidden");
    idx = 0;
    showQuestion();
  }
};

function showQuestion(){
  const q = deck[idx];
  questionText.textContent = `${idx+1}. ${q.é¡Œç›®}`;
  answerText.textContent = "ç­”æ¡ˆï¼š" + q.ç­”æ¡ˆ;
  answerText.classList.add("hidden");
  progressText.textContent = `ç¬¬ ${idx+1}/${deck.length} é¡Œã€€å°ç¯€ï¼š${q.å°ç¯€}`;
  checkBtn.classList.remove("hidden");
  wrongBtn.classList.add("hidden");
  rightBtn.classList.add("hidden");
  nextBtn.classList.add("hidden");
}

checkBtn.onclick = ()=>{
  answerText.classList.remove("hidden");
  checkBtn.classList.add("hidden");
  wrongBtn.classList.remove("hidden");
  rightBtn.classList.remove("hidden");
};

wrongBtn.onclick = ()=>{
  deck[idx].color = "red";
  goNext();
};

rightBtn.onclick = ()=>{
  const q = deck[idx];
  if(q.color === "red") q.color = "yellow";
  else if(q.color === "yellow") q.color = "green";
  else if(q.color === "green") q.color = "blue";
  goNext();
};

nextBtn.onclick = ()=> goNext();

function goNext(){
  idx++;
  if(idx >= deck.length) showStats();
  else showQuestion();
}

// âœ… ä¿®æ­£ç‰ˆï¼šæ­£ç¢ºçµ±è¨ˆé¡è‰²é‚è¼¯
function showStats(){
  quizBox.classList.add("hidden");
  statBox.classList.remove("hidden");
  const counts = { red:0, yellow:0, green:0, blue:0 };
  deck.forEach(q => {
    const c = q.color || "red";
    if (Object.prototype.hasOwnProperty.call(counts, c)) counts[c]++;
    else counts.red++;
  });
  const total = deck.length;
  document.getElementById("statResult").innerHTML =
    `ç´…ï¼š${counts.red}ã€€é»ƒï¼š${counts.yellow}ã€€ç¶ ï¼š${counts.green}ã€€è—ï¼š${counts.blue}ã€€<small>ï¼ˆç¸½è¨ˆ ${total} é¡Œï¼‰</small>`;
  const bar = document.getElementById("progressContainer");
  bar.innerHTML = "";
  ["red","yellow","green","blue"].forEach(c=>{
    const seg = document.createElement("div");
    seg.classList.add("progressSegment", c);
    seg.style.width = (counts[c]/total*100)+"%";
    bar.appendChild(seg);
  });
}

function filterColor(color){
  deck = allData.filter(q => q.å°ç¯€ === sectionSelect.value && q.color === color);
  if(deck.length === 0){ alert("æ²’æœ‰é€™é¡è‰²çš„é¡Œç›®å–”"); return; }
  idx = 0;
  statBox.classList.add("hidden");
  quizBox.classList.remove("hidden");
  showQuestion();
}

function restartAll(){
  deck = allData.filter(q => q.å°ç¯€ === sectionSelect.value);
  idx = 0;
  statBox.classList.add("hidden");
  quizBox.classList.remove("hidden");
  showQuestion();
}

function backToSetup(){
  statBox.classList.add("hidden");
  setupBox.classList.remove("hidden");
}
</script>
</body>
</html>
