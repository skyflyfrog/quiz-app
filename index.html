<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>天翔流自我強化檢核表</title>
<style>
body {
  font-family: "Noto Sans TC", sans-serif;
  background: #f4f5f7;
  text-align: center;
  margin: 0;
  padding: 40px 0;
}
h1 {
  font-size: 2em;
  margin-bottom: 20px;
}
p.description {
  color: #555;
  margin-bottom: 25px;
  font-size: 1.05em;
}
.container {
  background: white;
  border-radius: 16px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  margin: 0 auto;
  padding: 20px;
  width: 85%;
  max-width: 720px;
}
button {
  font-size: 1.1em;
  padding: 10px 24px;
  margin: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
#checkBtn { background: #008CBA; color: white; }
#wrongBtn { background: #f44336; color: white; }
#rightBtn { background: #4CAF50; color: white; }
#nextBtn { background: #333; color: white; }
.hidden { display: none; }
.progressBar {
  width: 100%;
  height: 20px;
  background: #ddd;
  border-radius: 10px;
  margin: 20px 0;
  overflow: hidden;
  display: flex;
}
.progressSegment { height: 100%; }
.red { background: #f44336; }
.yellow { background: #ffca28; }
.green { background: #4caf50; }
.blue { background: #2196f3; }
#question, #answer {
  color: black;
  font-size: 1.3em;
  margin: 15px 0;
}
</style>
</head>
<body>
<h1>天翔流自我強化檢核表</h1>
<p class="description">選擇你要刷的單元 → 載入題庫 → 選擇小節 → 開始刷</p>

<div class="container" id="setupBox">
  <label>選擇單元：</label>
  <select id="unitSelect"></select>
  <label>　選擇小節：</label>
  <select id="sectionSelect"></select><br>
  <button id="loadBtn">載入題庫</button>
</div>

<div class="container hidden" id="quizBox">
  <h3 id="progress"></h3>
  <h2 id="question"></h2>
  <p id="answer" class="hidden"></p>
  <div>
    <button id="checkBtn">對答案</button>
    <button id="wrongBtn" class="hidden">答錯</button>
    <button id="rightBtn" class="hidden">答對</button>
    <button id="nextBtn" class="hidden">下一題</button>
  </div>
</div>

<div class="container hidden" id="statBox">
  <h2>📊 統計結果</h2>
  <div id="progressContainer" class="progressBar"></div>
  <p id="statResult"></p>
  <button onclick="filterColor('red')" class="red">只刷紅色</button>
  <button onclick="filterColor('yellow')" class="yellow">只刷黃色</button>
  <button onclick="filterColor('green')" class="green">只刷綠色</button>
  <button onclick="filterColor('blue')" class="blue">只刷藍色</button><br>
  <button onclick="restartAll()">全部重刷</button>
  <button onclick="backToSetup()">回主畫面</button>
</div>

<script>
let allData = {};
let deck = [];
let idx = 0;
let currentSheet = "";
let currentSection = "";
const sheetUrl = "https://script.google.com/macros/s/AKfycbyzdhcYNXrPhqtPh2jaIhoO3FNZ1r1FdxB7obTXKWosJ4HRWCRoMEWgLZUgqUs3lYtGEg/exec";

const setupBox = document.getElementById("setupBox");
const quizBox = document.getElementById("quizBox");
const statBox = document.getElementById("statBox");
const questionText = document.getElementById("question");
const answerText = document.getElementById("answer");
const progressText = document.getElementById("progress");
const checkBtn = document.getElementById("checkBtn");
const wrongBtn = document.getElementById("wrongBtn");
const rightBtn = document.getElementById("rightBtn");
const nextBtn = document.getElementById("nextBtn");
const sectionSelect = document.getElementById("sectionSelect");
const unitSelect = document.getElementById("unitSelect");

// 🚀 自動抓分頁名稱
async function loadSheetList(){
  try{
    const res = await fetch(sheetUrl + "?mode=sheets");
    const data = await res.json();
    const sheets = data.sheets || [];
    if(sheets.length === 0) throw new Error("No sheets found");
    unitSelect.innerHTML = sheets.map(s => `<option value="${s}">${s}</option>`).join("");
  }catch(e){
    alert("⚠️ 無法取得試算表分頁清單，請確認 Apps Script 有回傳 sheets 陣列。");
  }
}

document.addEventListener("DOMContentLoaded", loadSheetList);

document.getElementById("loadBtn").onclick = async ()=>{
  try {
    currentSheet = unitSelect.value;
    const res = await fetch(sheetUrl + "?sheet=" + encodeURIComponent(currentSheet));
    allData[currentSheet] = await res.json();
    const sections = [...new Set(allData[currentSheet].map(q => q.小節))];
    sectionSelect.innerHTML = "<option value=''>請選擇</option>" + sections.map(s => `<option>${s}</option>`).join("");
  } catch (e) {
    alert("⚠️ 無法載入資料，請確認 Apps Script 網址是否正確發布。");
  }
};

sectionSelect.onchange = ()=>{
  currentSection = sectionSelect.value;
  if(currentSection){
    deck = allData[currentSheet].filter(q => q.小節 === currentSection);
    deck.forEach(q => q.color = q.color || "red");
    setupBox.classList.add("hidden");
    quizBox.classList.remove("hidden");
    idx = 0;
    showQuestion();
  }
};

function showQuestion(){
  const q = deck[idx];
  questionText.textContent = `${idx+1}. ${q.題目}`;
  answerText.textContent = "答案：" + q.答案;
  answerText.classList.add("hidden");
  progressText.textContent = `第 ${idx+1}/${deck.length} 題　小節：${q.小節}`;
  checkBtn.classList.remove("hidden");
  wrongBtn.classList.add("hidden");
  rightBtn.classList.add("hidden");
  nextBtn.classList.add("hidden");
}

checkBtn.onclick = ()=>{
  answerText.classList.remove("hidden");
  checkBtn.classList.add("hidden");
  wrongBtn.classList.remove("hidden");
  rightBtn.classList.remove("hidden");
};

wrongBtn.onclick = ()=>{
  updateColor(deck[idx], "red");
  goNext();
};

rightBtn.onclick = ()=>{
  const q = deck[idx];
  if(q.color === "red") updateColor(q, "yellow");
  else if(q.color === "yellow") updateColor(q, "green");
  else if(q.color === "green") updateColor(q, "blue");
  goNext();
};

nextBtn.onclick = ()=> goNext();

function updateColor(q, newColor){
  q.color = newColor;
  const target = allData[currentSheet].find(d => d.題目 === q.題目 && d.小節 === q.小節);
  if(target) target.color = newColor;
}

function goNext(){
  idx++;
  if(idx >= deck.length) showStats();
  else showQuestion();
}

function showStats(){
  quizBox.classList.add("hidden");
  statBox.classList.remove("hidden");

  const sectionData = allData[currentSheet].filter(q => q.小節 === currentSection);
  const counts = { red:0, yellow:0, green:0, blue:0 };
  sectionData.forEach(q => {
    const c = q.color || "red";
    counts[c] = (counts[c] || 0) + 1;
  });
  const total = sectionData.length;

  document.getElementById("statResult").innerHTML =
    `紅：${counts.red}　黃：${counts.yellow}　綠：${counts.green}　藍：${counts.blue}　<small>（總計 ${total} 題）</small>`;

  const bar = document.getElementById("progressContainer");
  bar.innerHTML = "";
  ["red","yellow","green","blue"].forEach(c=>{
    const seg = document.createElement("div");
    seg.classList.add("progressSegment", c);
    seg.style.width = (counts[c]/total*100)+"%";
    bar.appendChild(seg);
  });
}

function filterColor(color){
  deck = allData[currentSheet].filter(q => q.小節 === currentSection && q.color === color);
  if(deck.length === 0){ alert("沒有這顏色的題目喔"); return; }
  idx = 0;
  statBox.classList.add("hidden");
  quizBox.classList.remove("hidden");
  showQuestion();
}

function restartAll(){
  deck = allData[currentSheet].filter(q => q.小節 === currentSection);
  idx = 0;
  statBox.classList.add("hidden");
  quizBox.classList.remove("hidden");
  showQuestion();
}

function backToSetup(){
  statBox.classList.add("hidden");
  setupBox.classList.remove("hidden");
}
</script>
</body>
</html>
