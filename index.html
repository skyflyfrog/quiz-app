<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>天翔流自我強化檢核表</title>
<style>
:root{color-scheme:light!important;}
@media(prefers-color-scheme:dark){html,body{background:#f4f5f7!important;color:#000!important;}}
:root{--bg:#f4f5f7;--card:#fff;--muted:#64748b;--red:#ef4444;--yellow:#f59e0b;--green:#22c55e;--blue:#3b82f6;--barbg:#e5e7eb;}
body{font-family:"Noto Sans TC",sans-serif;background:var(--bg);margin:0;text-align:center;padding:28px 0;color:#000;}
.container{background:var(--card);border-radius:16px;box-shadow:0 0 10px rgba(0,0,0,.08);margin:14px auto;padding:16px;width:92%;max-width:900px;text-align:left;}
.section-header{font-weight:700;margin:10px 0 6px}
.small{color:var(--muted);font-size:.92rem}
.btn{font-size:1rem;padding:9px 14px;border:none;border-radius:8px;cursor:pointer;margin:6px 6px 0 0}
.btn-prim{background:#0ea5e9;color:#fff}.btn-red{background:#ef4444;color:#fff}.btn-ghost{background:#fff;border:1px solid #cbd5e1;color:#334155}
.q{font-weight:800;font-size:1.25rem;margin:10px 0}.ans{color:#000;font-size:1.25rem;margin:10px 0}
.progressBar{width:100%;height:16px;background:var(--barbg);border-radius:8px;overflow:hidden;display:flex;}
.segment{height:100%}.red{background:var(--red)}.yellow{background:var(--yellow)}.green{background:var(--green)}.blue{background:var(--blue)}
img.question-img{max-width:100%;border-radius:10px;margin:10px 0}
.hidden{display:none}
</style>
</head>
<body>
<h1>天翔流自我強化檢核表</h1>
<p>紅：0輪 ｜ 黃：1輪 ｜ 綠：2輪 ｜ 藍：3輪</p>

<div class="container" id="homeBox">
  <div class="small">登入者：<span id="userNameDisplay"></span></div>
  <div id="overview">載入中…</div>
</div>

<div class="container hidden" id="quizBox">
  <div class="small"><span id="crumb"></span>　<span id="progressText"></span></div>
  <div id="qText" class="q"></div>
  <div id="imgWrap" class="hidden"></div>
  <div id="aText" class="ans hidden"></div>
  <div>
    <button id="checkBtn" class="btn btn-prim">對答案</button>
    <button id="wrongBtn" class="btn btn-red hidden">答錯</button>
    <button id="rightBtn" class="btn btn-prim hidden">答對</button>
    <button id="cancelBtn" class="btn btn-ghost">回首頁（不儲存）</button>
  </div>
</div>

<div class="container hidden" id="computingBox"><div class="small">結果統計中…</div></div>

<div class="container hidden" id="statBox">
  <div class="section-header" id="statTitle"></div>
  <div id="statSummary" class="small"></div>
  <div id="statBar" class="progressBar" style="margin:10px 0 6px"></div>
  <button id="homeBtn" class="btn btn-ghost">回首頁</button>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyzdhcYNXrPhqtPh2jaIhoO3FNZ1r1FdxB7obTXKWosJ4HRWCRoMEWgLZUgqUs3lYtGEg/exec";
let userName=localStorage.getItem("quizUserName");
if(!userName){userName=prompt("請輸入姓名：");if(!userName)userName="未命名";localStorage.setItem("quizUserName",userName);}
document.getElementById("userNameDisplay").textContent=userName;

const overview=document.getElementById("overview"),homeBox=document.getElementById("homeBox"),quizBox=document.getElementById("quizBox"),
computingBox=document.getElementById("computingBox"),statBox=document.getElementById("statBox"),
qText=document.getElementById("qText"),aText=document.getElementById("aText"),imgWrap=document.getElementById("imgWrap"),
crumb=document.getElementById("crumb"),progressText=document.getElementById("progressText"),
checkBtn=document.getElementById("checkBtn"),wrongBtn=document.getElementById("wrongBtn"),rightBtn=document.getElementById("rightBtn"),
homeBtn=document.getElementById("homeBtn"),cancelBtn=document.getElementById("cancelBtn");

let meta={sheets:[],data:{},sections:{}};
let session={sheet:"",section:"",deck:[],idx:0,working:[]};

async function loadSheets(){const r=await fetch(API+"?mode=sheets",{cache:"no-store"});const j=await r.json();meta.sheets=j.sheets||[];}
async function loadSheetData(sheet){if(meta.data[sheet])return;const r=await fetch(API+"?sheet="+encodeURIComponent(sheet),{cache:"no-store"});const rows=await r.json();meta.data[sheet]=rows;}
async function buildOverview(){
  overview.innerHTML="";
  for(const sheet of meta.sheets){
    await loadSheetData(sheet);
    const wrap=document.createElement("div");
    wrap.className="btn btn-ghost";
    wrap.textContent=sheet;
    wrap.onclick=()=>onChooseSection(sheet);
    overview.appendChild(wrap);
  }
}

async function onChooseSection(sheet){
  session.sheet=sheet;
  session.deck=meta.data[sheet].map(x=>({...x,color:"red"}));
  const saved=await loadProgressFromServer(sheet);
  if(saved){session.working=saved;}else{session.working=session.deck;}
  homeBox.classList.add("hidden");quizBox.classList.remove("hidden");
  session.idx=0;showQuestion();
}

function extractImageUrl(text){const m=text.match(/https?:\/\/[^\s"<]+/);if(!m)return null;const u=m[0];return /\.(png|jpg|jpeg|gif)/i.test(u)||/drive\.google\.com\/uc\?id=/i.test(u)?u:null;}
function showQuestion(){
  const q=session.working[session.idx];
  crumb.textContent=session.sheet;progressText.textContent=`第 ${session.idx+1}/${session.working.length} 題`;
  qText.textContent=q.題目||"";aText.textContent=`答案：${q.答案}`;aText.classList.add("hidden");
  const imgUrl=q.圖片||extractImageUrl(q.題目);
  if(imgUrl){imgWrap.innerHTML=`<img class="question-img" src="${imgUrl}">`;imgWrap.classList.remove("hidden");}else{imgWrap.classList.add("hidden");}
  checkBtn.classList.remove("hidden");wrongBtn.classList.add("hidden");rightBtn.classList.add("hidden");
}

checkBtn.onclick=()=>{aText.classList.remove("hidden");checkBtn.classList.add("hidden");wrongBtn.classList.remove("hidden");rightBtn.classList.remove("hidden");};
wrongBtn.onclick=()=>{applyColor("red");nextQuestion();};
rightBtn.onclick=()=>{applyColor("green");nextQuestion();};
cancelBtn.onclick=()=>{if(confirm("確定要回首頁？不儲存進度。")){quizBox.classList.add("hidden");homeBox.classList.remove("hidden");}};
homeBtn.onclick=()=>{statBox.classList.add("hidden");homeBox.classList.remove("hidden");};

function applyColor(color){session.working[session.idx].color=color;}
function nextQuestion(){
  session.idx++;
  if(session.idx>=session.working.length){
    quizBox.classList.add("hidden");
    computingBox.classList.remove("hidden");
    saveProgressToServer(session.sheet,session.working).then(()=>{
      setTimeout(()=>{computingBox.classList.add("hidden");statBox.classList.remove("hidden");document.getElementById("statTitle").textContent=`${session.sheet} 完成`;},1000);
    });
  }else showQuestion();
}

// === 雲端紀錄處理 ===
async function saveProgressToServer(sheet,data){
  await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({mode:"save",user:userName,sheet,data})
  });
}
async function loadProgressFromServer(sheet){
  const r=await fetch(API+`?mode=load&user=${encodeURIComponent(userName)}&sheet=${encodeURIComponent(sheet)}`,{cache:"no-store"});
  const j=await r.json();
  return j.records||null;
}

(async()=>{await loadSheets();await buildOverview();})();
</script>
</body>
</html>
